<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Query terrain elevation</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <link href="./mapbox-gl.css" rel="stylesheet">
  <script src="./mapbox-gl.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }

    /* change background and tip color to green */
    .apple-popup .mapboxgl-popup-content {
      /* background-color: green; */
      padding: 2px 4px 2px;
    }

    .apple-popup .mapboxgl-popup-tip {
      /* border-top-color: green; */
      border-top-width: 6px;
      border-left-width: 6px;
      border-right-width: 6px;
      border-bottom-width: 6px;
    }
  </style>
</head>

<body>
  <script src="./data.js"></script>
  <script src="./turf.min.js"></script>
  <div id="map"></div>
  <div style="background-color:#00000000 ;margin: 10px; position:absolute;top: 0;left: 0;width: 100px;height: 40px;"
    onclick="play()">play</div>
  <div style="background-color:#00000000 ;margin: 10px; position:absolute;top: 0;left: 120px;width: 100px;height: 40px;"
    onclick="stop()">
    stop
    <div>
      <script>

        var stop;
        var play;

        mapboxgl.accessToken = 'pk.eyJ1IjoiYW5ncnljYW5zIiwiYSI6ImNsMm8ycXdwdzAxeTczY204cXJ5ajBzeXEifQ.6Ln8QhR1LGdJC7YLjdZXsQ';
        (async () => {

          const mapStyle = {
            "version": 8,
            "name": "Dark",
            "sources": {
              "mapbox": {
                "type": "vector",
                "url": "mapbox://mapbox.mapbox-streets-v8"
              },
            },
            "sprite": "mapbox://sprites/mapbox/dark-v10",
            "glyphs": "mapbox://fonts/mapbox/{fontstack}/{range}.pbf",
            "layers": [
            ],
          };
          const map = new mapboxgl.Map({
            container: 'map',
            //style: mapStyle,
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [118.98599817, 31.93399250],
            zoom: 18
          });

          let trackJosn = {
            LapIdx2: 6,
            lap: [
              { prv: 336, idx: 345, timer: 61603, maxspeed: 95.71 }
              , { prv: 336, idx: 644, timer: 61603, maxspeed: 95.71 }
              , { prv: 644, idx: 959, timer: 63813, maxspeed: 97.88 }
              , { prv: 959, idx: 1267, timer: 61589, maxspeed: 99.66 }
              , { prv: 1267, idx: 1575, timer: 61594, maxspeed: 96.23 }
              , { prv: 1575, idx: 1883, timer: 61592, maxspeed: 96.45 }
              , { prv: 1883, idx: 2196, timer: 62618, maxspeed: 97.4 }
              , { prv: 2196, idx: 2503, timer: 61390, maxspeed: 98.08 }
              , { prv: 2503, idx: 2810, timer: 61428, maxspeed: 99.75 }
            ]
          }
          //const _item = sessionTxt.split("\r\n");
          // let coords = _item.map(item => {
          //   let s = item.split(",")
          //   return [s[2], s[1]]
          // })

          let lastItem;
          let coords = [];

          // sessionData = sessionTxt.map((_item, idx) => {

          let sessionData = [];
          let sessionTxt = data.split("\n");
          // console.log(sessionTxt);
          for (let idx = 0; idx < sessionTxt.length; idx++) {
            let item = sessionTxt[idx].split(",");

            let GForc;
            let tmpvel;
            let tmpMillis;
            let vel = +item[4];

            let ms = 0

            if (idx == 0) {
              tmpvel = item[4];
              tmpMillis = 10
            } else {
              tmpvel = lastItem[4];
              tmpMillis = +item[6] - lastItem[6];

            }
            if (idx === sessionTxt.length - 1) {
              ms = 0;
            } else {
              let nexitem = sessionTxt[idx + 1].split(",");
              ms = nexitem[6] - item[6]

            }
            GForc = (((vel - tmpvel) / 3.6) / (9.8 * tmpMillis / 1000)).toFixed(2);
            lastItem = item;
            item.push(GForc);
            item.push(ms);
            //return item;
            sessionData.push(item);
            // coords.push([item[2], item[1]]);
          }

          sessionData.forEach((item, i) => {
            if ((i >= trackJosn.lap[trackJosn.LapIdx2].prv) && (i <= trackJosn.lap[trackJosn.LapIdx2].idx)) {
              coords.push([item[2], item[1]])
            }
          })

          // coords.push([_item[2], _item[1]]);
          console.log("coords", coords);
          console.log("sessionData", sessionData);
          console.log("lap", trackJosn.lap[trackJosn.LapIdx2]);
          let gJosn = {
            type: 'Feature',
            properties: {},
            geometry: {
              type: 'LineString',
              coordinates: coords
            }
          }


          const sessionJosn = {
            'type': 'FeatureCollection',
            'features': [
              {
                'type': 'Feature',
                'geometry': {
                  'type': 'LineString',
                  'coordinates': coords
                }
              }
            ]
          };


          map.on('load', () => {

            // Create the marker and popup that will display the elevation queries
            const popup = new mapboxgl.Popup({ closeButton: false, className: "apple-popup" });
            const marker = new mapboxgl.Marker({
              color: 'red',
              scale: 0.8,
              draggable: false,
              pitchAlignment: 'auto',
              rotationAlignment: 'auto'
            })
              .setLngLat(coords[0])
              .setPopup(popup)
              .addTo(map)
              .togglePopup();

            map.addSource('route', {
              'type': 'geojson',
              'data': gJosn

            });
            // map.addLayer({
            //   'id': 'route',
            //   'source': 'route',
            //   'type': 'line',
            //   'paint': {
            //     'line-width': 4,
            //     'line-color': '#007cbf'
            //   }
            // });

            map.addLayer({
              type: 'line',
              source: 'route',
              id: 'line',
              paint: {
                'line-color': '#007cbf',
                'line-width': 5
              },
              layout: {
                'line-cap': 'round',
                'line-join': 'round'
              }
            });


            let aniIdx = 0;
            let start = 0;

            let aniIdx_session;// = trackJosn.lap[trackJosn.LapIdx2].prv + aniIdx;
            let pinRoute = [];// = [coords[aniIdx], coords[aniIdx + 1]];
            let animationDuration;//= sessionData[aniIdx_session][8];//4090528 - 4090328;

            let lapStartTime = 0;//=performance.now();
            let lapEndTime = 0;//=performance.now();

            let difflngLat = {};
            let difftime = 0;
            let lasttime = 0;
            let pause = false;
            let usepause = false;
            let stime;
            var timerId;

            function frame(time) {
              if (start == 0) {
                start = time;
                if (!lapStartTime) {
                  lapStartTime = time;
                  console.log("lapStartTime", lapStartTime.toFixed())
                }
                start -= lasttime == 0 ? 17 : time - lasttime; //因为每次开始点都从路由的第一个点开始,而每次点都在开始位置,所以跳过一帧.
              }

              aniIdx_session = trackJosn.lap[trackJosn.LapIdx2].prv + aniIdx;
              if (difftime > 0) {

                // pinRoute = [[difflngLat.lng, difflngLat.lat], coords[aniIdx + 1]];
                pinRoute = [coords[aniIdx], coords[aniIdx + 1]];
                animationDuration = sessionData[aniIdx_session][8] - difftime;
              } else {

                pinRoute = [coords[aniIdx], coords[aniIdx + 1]];
                animationDuration = sessionData[aniIdx_session][8];
                // console.log("diff2", diff2, sessionData[aniIdx_session][8], animationDuration.toFixed())
              }
              // pinRoute = [coords[aniIdx], coords[aniIdx + 1]];
              //animationDuration = sessionData[aniIdx_session][8] + diff2;//4090528 - 4090328;
              let path = turf.lineString(pinRoute);
              let pathDistance = turf.lineDistance(path);


              let animationPhase = (time - start) / animationDuration;

              let diff = (time - start).toFixed() - animationDuration;
              //console.log("timer", aniIdx, coords.length, start.toFixed(), time, sessionData[aniIdx_session][8], animationDuration.toFixed(), animationPhase.toFixed(2), (time - start).toFixed(), difftime, time.toFixed());
              console.log("timer", start.toFixed(), time, sessionData[aniIdx_session][8], animationDuration.toFixed(), animationPhase.toFixed(2), (time - start).toFixed(), difftime, time.toFixed(), (lasttime == 0 ? 17 : time - lasttime).toFixed());
              lasttime = time;

              if (diff >= 0) {
                difftime = diff;
                animationPhase = 1;

                difflngLat = marker.getLngLat();

                //  console.log("point ", sessionData[aniIdx_session]);
                console.log("point route end to next", aniIdx, sessionData[aniIdx_session][8], sessionData[aniIdx_session + 1][6] - sessionData[trackJosn.lap[trackJosn.LapIdx2].prv][6], (time - start).toFixed(), diff, (time - lapStartTime).toFixed());
                console.log("point ", sessionData[aniIdx_session]);
                console.log("point ", sessionData[aniIdx_session + 1]);
                console.log("maker ", marker.getLngLat().lng, marker.getLngLat().lat);

                aniIdx++;
                start = 0;
                //window.requestAnimationFrame(frame);
                //return;

                if (aniIdx === coords.length - 1) {
                  // window.requestAnimationFrame(frame);
                  console.log("aniIdx > coords.length", aniIdx, coords.length)
                  lapEndTime = time;
                  console.log("endtime", sessionData[trackJosn.lap[trackJosn.LapIdx2].idx][6] - sessionData[trackJosn.lap[trackJosn.LapIdx2].prv][6], lapEndTime - lapStartTime)
                  console.log("performance", performance.now() - stime)
                  return;
                }
                if (pause) {
                  usepause = true;
                }

              } else {
                // difftime = 0;
              }

              // Get the new latitude and longitude by sampling along the path
              const alongPath = turf.along(path, pathDistance * animationPhase)
                .geometry.coordinates;
              const lngLat = {
                lng: alongPath[0],
                lat: alongPath[1]
              };

              // Update the popup altitude value and marker location
              popup.setHTML(sessionData[aniIdx_session][4] + ' ' + sessionData[aniIdx_session][7] + '<br/>');
              marker.setLngLat(lngLat);


              // map.panTo(lngLat);

              // Reduce the visible length of the line by using a line-gradient to cutoff the line
              // animationPhase is a value between 0 and 1 that reprents the progress of the animation
              map.setPaintProperty('line', 'line-gradient', [
                'step',
                ['line-progress'],
                'red',
                animationPhase,
                'rgba(255, 0, 0, 0)'
              ]);

              // Rotate the camera at a slightly lower speed to give some parallax effect in the background
              //aniIdx++;

              if (!usepause) {
                timerId = window.requestAnimationFrame(frame);
              }

            }

            //  window.requestAnimationFrame(frame);


            play = function play() {
              console.log("play");
              stime = performance.now();
              // aniIdx = 0;
              // start = 0;

              // aniIdx_session;// = trackJosn.lap[trackJosn.LapIdx2].prv + aniIdx;
              // pinRoute = [];// = [coords[aniIdx], coords[aniIdx + 1]];
              // animationDuration;//= sessionData[aniIdx_session][8];//4090528 - 4090328;

              // lapStartTime = 0;//=performance.now();
              // lapEndTime = 0;//=performance.now();

              // difflngLat = {};
              // difftime = 0;
              lasttime = 0;
              pause = false;
              usepause = false;
              start = 0;
              timerId = window.requestAnimationFrame(frame);

            }

            stop = function stop() {
              console.log("stop", pause)
              pause = true;
            }

          });


          await map.once('idle');

        })();



      </script>

</body>

</html>